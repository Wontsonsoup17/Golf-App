<!DOCTYPE html>
<html lang="en">
<head>
<style>html,body{background:#0a0f0d}</style>
<meta charset="UTF-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Updating... - Westchester Golf</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #0a0f0d; color: #e0e0e0; display: flex; align-items: center;
    justify-content: center; min-height: 100vh; text-align: center; padding: 24px;
  }
  .container { max-width: 340px; }
  .spinner {
    width: 48px; height: 48px; border: 4px solid rgba(255,255,255,0.1);
    border-top-color: #d4af37; border-radius: 50%; margin: 0 auto 20px;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  h2 { font-size: 18px; margin-bottom: 8px; color: #fff; }
  p { font-size: 13px; color: #999; line-height: 1.5; }
  .status { margin-top: 16px; font-size: 12px; color: #d4af37; font-weight: 600; }
</style>
</head>
<body>
<div class="container">
  <div class="spinner"></div>
  <h2>Updating App</h2>
  <p>Clearing cached data and loading the latest version...</p>
  <div class="status" id="status">Registering updater...</div>
</div>

<script>
(function() {
  var statusEl = document.getElementById('status');
  function setStatus(msg) { if (statusEl) statusEl.textContent = msg; }

  // Step 1: Register service worker that forces network-first loading
  // This is the key fix — once active, ALL future page loads bypass the HTTP cache
  var swPromise = Promise.resolve();
  if ('serviceWorker' in navigator) {
    swPromise = navigator.serviceWorker.register('sw.js', { updateViaCache: 'none' })
      .then(function(reg) {
        setStatus('Updater installed. Clearing caches...');
        // Wait for the SW to activate
        return new Promise(function(resolve) {
          var sw = reg.installing || reg.waiting || reg.active;
          if (sw && sw.state === 'activated') { resolve(); return; }
          if (sw) {
            sw.addEventListener('statechange', function() {
              if (sw.state === 'activated') resolve();
            });
          } else { resolve(); }
          // Safety timeout — don't wait forever
          setTimeout(resolve, 3000);
        });
      })
      .catch(function(err) {
        // SW registration failed (e.g. not HTTPS in dev) — continue anyway
        setStatus('Clearing caches...');
      });
  }

  swPromise.then(function() {
    setStatus('Clearing all cached data...');

    // Step 2: Clear ALL localStorage
    try { localStorage.clear(); } catch(e) {}

    // Step 3: Clear ALL sessionStorage
    try { sessionStorage.clear(); } catch(e) {}

    // Step 4: Clear ALL Cache API caches
    var cachePromise = Promise.resolve();
    if (window.caches) {
      cachePromise = caches.keys().then(function(names) {
        return Promise.all(names.map(function(name) { return caches.delete(name); }));
      }).catch(function() {});
    }

    return cachePromise;
  }).then(function() {
    setStatus('Done! Redirecting to login...');

    // Step 5: Redirect to login with cache-busting
    setTimeout(function() {
      window.location.replace('login.html?_forceclear=' + Date.now());
    }, 800);
  }).catch(function() {
    setStatus('Done. Redirecting...');
    setTimeout(function() {
      window.location.replace('login.html?_forceclear=' + Date.now());
    }, 800);
  });
})();
</script>
</body>
</html>
