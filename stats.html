<!DOCTYPE html>
<html lang="en">
<head>
<style>html,body{background:#0a0f0d}</style>
<script>
(function(){var v='135';var k='app_v';var s=localStorage.getItem(k);if(s&&s!==v){localStorage.setItem(k,v);window.location.replace(window.location.pathname+'?_='+Date.now());return;}localStorage.setItem(k,v);})();
</script>
<meta charset="UTF-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0a0f0d">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<title>Stats - Westchester Golf</title>
<link rel="stylesheet" href="shared.css?v=148">
</head>
<body>

<div class="header">
  <h1>Leaderboard</h1>
  <div class="subtitle">Community rankings</div>
</div>

<div id="activeRoundBanner"></div>

<div class="main">
  <div class="stat-grid" id="statGrid"></div>
  <div id="leaderboardSection">
    <div class="waiting-players"><span class="spinner"></span> Loading stats...</div>
  </div>
</div>

<nav class="bottom-nav" id="bottomNav"></nav>

<script src="firebase-config.js?v=148"></script>
<script src="shared.js?v=148"></script>
<script src="firebase-sync.js?v=148"></script>
<script>
  requireAuth(function(user) {
    renderBottomNav('stats');
    renderActiveRoundBanner();

    // Load from Firebase
    fbLoadRounds(user.uid).then(rounds => {
      renderStats(rounds);
    }).catch(() => {
      renderStats(loadRounds());
    });

    function renderStats(rounds) {
      if (!rounds.length) {
        document.getElementById('statGrid').innerHTML = '';
        document.getElementById('leaderboardSection').innerHTML = `<div class="empty-state"><div class="icon">&#128202;</div><p>Play some rounds to see your stats!<br><a href="index.html">Get started</a></p></div>`;
        return;
      }

      const totalRounds = rounds.length;
      const allPlayers = new Set();
      rounds.forEach(r => r.players.forEach(p => allPlayers.add(p)));
      const courseCount = new Set(rounds.map(r => r.courseId)).size;

      let bestScore = Infinity, bestPlayer = '';
      rounds.forEach(r => r.players.forEach(p => {
        const total = r.scores[p].reduce((a,b)=>a+b,0);
        const played = r.scores[p].filter(s=>s>0).length;
        if (played >= 9 && total > 0 && total < bestScore) { bestScore = total; bestPlayer = p; }
      }));

      document.getElementById('statGrid').innerHTML = `
        <div class="stat-box"><div class="stat-value">${totalRounds}</div><div class="stat-label">Rounds</div></div>
        <div class="stat-box"><div class="stat-value">${courseCount}</div><div class="stat-label">Courses</div></div>
        <div class="stat-box"><div class="stat-value">${allPlayers.size}</div><div class="stat-label">Players</div></div>
        <div class="stat-box"><div class="stat-value">${bestScore < Infinity ? bestScore : '-'}</div><div class="stat-label">Best${bestPlayer ? ' ('+bestPlayer+')' : ''}</div></div>
      `;

      // Leaderboard
      const ps = {};
      rounds.forEach(r => r.players.forEach(p => {
        const total = r.scores[p].reduce((a,b)=>a+b,0);
        const played = r.scores[p].filter(s=>s>0).length;
        if (total > 0 && played >= 9) {
          if (!ps[p]) ps[p] = { rounds:0, totalScore:0, totalPar:0, wins:0, best:Infinity };
          ps[p].rounds++;
          ps[p].totalScore += total;
          ps[p].totalPar += r.par;
          if (total < ps[p].best) ps[p].best = total;
        }
      }));

      rounds.forEach(r => {
        let min = Infinity, winners = [];
        r.players.forEach(p => {
          const t = r.scores[p].reduce((a,b)=>a+b,0);
          if (t > 0 && t < min) { min = t; winners = [p]; }
          else if (t === min && t > 0) winners.push(p);
        });
        winners.forEach(w => { if (ps[w]) ps[w].wins++; });
      });

      const sorted = Object.entries(ps)
        .map(([name,s]) => ({ name, avg:(s.totalScore/s.rounds).toFixed(1), rounds:s.rounds, wins:s.wins, best:s.best }))
        .sort((a,b) => parseFloat(a.avg) - parseFloat(b.avg));

      let lbHtml = '<div class="leaderboard"><h3>Player Leaderboard</h3>';
      if (!sorted.length) {
        lbHtml += '<p style="color:var(--text-muted);font-size:13px">Complete a round with 9+ holes.</p>';
      } else {
        sorted.forEach((p, i) => {
          const rc = i===0?'':i===1?'r2':i===2?'r3':'r4';
          lbHtml += `
            <div class="lb-row">
              <div class="lb-rank ${rc}">${i+1}</div>
              <span class="lb-name">${p.name}</span>
              <span class="lb-meta">${p.rounds}R &bull; ${p.wins}W<br>Best: ${p.best}</span>
              <span class="lb-stat">${p.avg}</span>
            </div>
          `;
        });
      }
      lbHtml += '</div>';
      document.getElementById('leaderboardSection').innerHTML = lbHtml;
    }
  });
</script>
</body>
</html>
