<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0a0f0d">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<title>Sign In - Westchester Golf</title>
<link rel="stylesheet" href="shared.css?v=21">
</head>
<body>

<div class="hero" style="padding-bottom:20px">
  <div class="hero-logo">&#9971;</div>
  <h1>Westchester Golf</h1>
  <p>Sign in to track your rounds</p>
</div>

<div class="main" style="padding-top:0">
  <div class="auth-card">
    <!-- Tab toggle -->
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchTab('signin')">Sign In</button>
      <button class="auth-tab" onclick="switchTab('signup')">Sign Up</button>
    </div>

    <!-- Error display -->
    <div class="auth-error" id="authError"></div>

    <!-- Sign In Form -->
    <div id="signinForm">
      <div class="form-group">
        <label>Username</label>
        <input type="text" id="signinUsername" placeholder="Your username" maxlength="20" autocomplete="username" autocapitalize="none" readonly onfocus="this.removeAttribute('readonly')">
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="signinPassword" placeholder="Your password" autocomplete="current-password" readonly onfocus="this.removeAttribute('readonly')">
      </div>
      <button class="btn-gold" id="signinBtn" onclick="handleSignIn()">Sign In</button>
    </div>

    <!-- Sign Up Form -->
    <div id="signupForm" style="display:none">
      <div class="form-group">
        <label>Username</label>
        <input type="text" id="signupUsername" placeholder="Choose a username" maxlength="20" autocomplete="username" autocapitalize="none" readonly onfocus="this.removeAttribute('readonly')">
        <div style="font-size:11px; color:var(--text-muted); margin-top:4px;">Letters, numbers, and underscores only</div>
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="signupPassword" placeholder="At least 6 characters" autocomplete="new-password" readonly onfocus="this.removeAttribute('readonly')">
      </div>
      <div class="form-group">
        <label>Confirm Password</label>
        <input type="password" id="signupConfirm" placeholder="Confirm your password" autocomplete="new-password" readonly onfocus="this.removeAttribute('readonly')">
      </div>
      <!-- Optional profile photo -->
      <div class="form-group" style="text-align:center">
        <label>Profile Photo <span style="color:var(--text-muted);font-weight:400">(optional)</span></label>
        <div id="signupAvatarPreview" class="signup-avatar-preview" onclick="document.getElementById('signupAvatarInput').click()">
          <span class="signup-avatar-placeholder">&#128247; Tap to add</span>
        </div>
        <input type="file" id="signupAvatarInput" accept="image/*" style="display:none" onchange="previewSignupAvatar(this)">
      </div>

      <button class="btn-gold" id="signupBtn" onclick="handleSignUp()">Create Account</button>
    </div>
  </div>

  <div style="text-align:center;margin-top:24px;padding-bottom:20px">
    <div style="font-size:13px;color:var(--text-muted);margin-bottom:8px">If having issues</div>
    <a href="clear-cache.html" class="btn-outline" style="display:inline-block;font-size:13px;padding:8px 20px;text-decoration:none">Clear Cache</a>
  </div>
</div>

<script src="firebase-config.js?v=21"></script>
<script src="shared.js?v=21"></script>
<script>
  let signingUp = false;
  let pendingAvatarData = null;

  function previewSignupAvatar(input) {
    var file = input.files && input.files[0];
    if (!file) return;
    processProfileImage(file).then(function(dataUrl) {
      pendingAvatarData = dataUrl;
      var preview = document.getElementById('signupAvatarPreview');
      preview.innerHTML = '<img src="' + dataUrl + '">';
      preview.classList.add('has-image');
    }).catch(function(err) {
      alert(err.message || 'Could not process image.');
    });
    input.value = '';
  }

  // If already signed in, redirect to home
  onAuthReady(user => {
    if (user && !signingUp) window.location.href = 'index.html';
  });

  // Convert username to a fake email for Firebase Auth
  function usernameToEmail(username) {
    return username.toLowerCase().trim() + '@westchestergolf.app';
  }

  function switchTab(tab) {
    document.getElementById('signinForm').style.display = tab === 'signin' ? '' : 'none';
    document.getElementById('signupForm').style.display = tab === 'signup' ? '' : 'none';
    document.querySelectorAll('.auth-tab').forEach((btn, i) => {
      btn.classList.toggle('active', (tab === 'signin' && i === 0) || (tab === 'signup' && i === 1));
    });
    clearError();
  }

  function showError(msg) {
    const el = document.getElementById('authError');
    el.textContent = msg;
    el.style.display = 'block';
  }

  function clearError() {
    const el = document.getElementById('authError');
    el.textContent = '';
    el.style.display = 'none';
  }

  function setLoading(btn, loading) {
    btn.disabled = loading;
    btn.style.opacity = loading ? '0.6' : '1';
  }

  function isValidUsername(name) {
    return /^[a-zA-Z0-9_]{2,20}$/.test(name);
  }

  function handleSignIn() {
    clearError();
    const username = document.getElementById('signinUsername').value.trim();
    const password = document.getElementById('signinPassword').value;
    if (!username || !password) { showError('Please fill in all fields.'); return; }

    const btn = document.getElementById('signinBtn');
    setLoading(btn, true);

    const email = usernameToEmail(username);

    auth.signInWithEmailAndPassword(email, password)
      .then(() => {
        window.location.href = 'index.html';
      })
      .catch(err => {
        setLoading(btn, false);
        if (err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password' || err.code === 'auth/invalid-credential') {
          showError('Invalid username or password.');
        } else if (err.code === 'auth/too-many-requests') {
          showError('Too many attempts. Please try again later.');
        } else {
          showError('Invalid username or password.');
        }
      });
  }

  function handleSignUp() {
    clearError();
    const username = document.getElementById('signupUsername').value.trim();
    const password = document.getElementById('signupPassword').value;
    const confirm = document.getElementById('signupConfirm').value;

    if (!username) { showError('Please choose a username.'); return; }
    if (!isValidUsername(username)) { showError('Username must be 2-20 characters: letters, numbers, underscores only.'); return; }
    if (password.length < 6) { showError('Password must be at least 6 characters.'); return; }
    if (password !== confirm) { showError('Passwords do not match.'); return; }

    const btn = document.getElementById('signupBtn');
    setLoading(btn, true);
    signingUp = true;

    const email = usernameToEmail(username);

    // Clear any stale local data for this username before sign-up
    var localUsers = getLocalUsers();
    if (localUsers[username.toLowerCase()]) {
      delete localUsers[username.toLowerCase()];
      saveLocalUsers(localUsers);
    }

    // Check if username is taken — use Firebase directly, skip local fallback
    _firebaseLoadPromise.then(function() {
      if (_firebaseReady && _firebaseDB) {
        return _firebaseDB.ref('usernames/' + username.toLowerCase()).once('value');
      }
      // Firebase not available — skip uniqueness check, proceed with sign-up
      return Promise.resolve({ exists: function() { return false; } });
    }).then(function(snap) {
      if (snap.exists()) {
        setLoading(btn, false);
        showError('That username is already taken.');
        return;
      }

      return auth.createUserWithEmailAndPassword(email, password)
        .then(cred => {
          // Set display name
          return cred.user.updateProfile({ displayName: username }).then(() => {
            // Reserve username and save profile in Firebase (use individual refs so they route to Firebase)
            return Promise.all([
              db.ref('usernames/' + username.toLowerCase()).set(cred.user.uid),
              db.ref('users/' + cred.user.uid + '/profile').set({
                username: username,
                createdAt: Date.now()
              })
            ]);
          });
        })
        .then(() => {
          if (pendingAvatarData) {
            setUserAvatar(auth.currentUser.uid, pendingAvatarData);
          }
          window.location.href = 'index.html';
        });
    }).catch(err => {
      setLoading(btn, false);
      if (err.code === 'auth/email-already-in-use') {
        showError('That username is already taken.');
      } else if (err.code === 'auth/weak-password') {
        showError('Password must be at least 6 characters.');
      } else {
        showError(err.message || 'Could not create account.');
      }
    });
  }

  // Enter key triggers submit
  document.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      if (document.getElementById('signinForm').style.display !== 'none') {
        handleSignIn();
      } else {
        handleSignUp();
      }
    }
  });
</script>
</body>
</html>
