<!DOCTYPE html>
<html lang="en">
<head>
<script>
(function(){var v='108';var k='app_v';var s=localStorage.getItem(k);if(s&&s!==v){localStorage.setItem(k,v);window.location.replace(window.location.pathname+'?_='+Date.now());return;}localStorage.setItem(k,v);})();
</script>
<meta charset="UTF-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0a0f0d">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<title>History - Westchester Golf</title>
<link rel="stylesheet" href="shared.css?v=110">
</head>
<body>

<div class="header">
  <h1>Round History</h1>
  <div class="subtitle">All your saved rounds</div>
</div>

<div id="activeRoundBanner"></div>

<div class="main">
  <div id="historyList">
    <div class="waiting-players"><span class="spinner"></span> Loading rounds...</div>
  </div>
</div>

<div class="modal-overlay" id="detailModal">
  <div class="modal">
    <h3 id="detailTitle"></h3>
    <div id="detailContent" style="overflow-x:auto"></div>
    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeModal()">Close</button>
    </div>
  </div>
</div>

<nav class="bottom-nav" id="bottomNav"></nav>

<script src="firebase-config.js?v=110"></script>
<script src="shared.js?v=110"></script>
<script src="firebase-sync.js?v=110"></script>
<script>
  requireAuth(function(user) {
    renderBottomNav('history');
    renderActiveRoundBanner();

    let rounds = [];

    // Determine if a round was ended early.
    // Trust the saved `incomplete` flag when present (set by scorecard based on
    // the saving player's own holes played). Fall back to checking scores only
    // for very old rounds that don't have the flag.
    function isRoundIncomplete(r) {
      if (typeof r.incomplete === 'boolean') return r.incomplete;
      return r.players.some(p => r.scores[p].filter(s => s > 0).length < 18);
    }

    // Load from Firebase (primary source), with localStorage as display-only fallback.
    // Rounds are saved to both Firebase and localStorage at creation time,
    // so we do NOT re-upload local-only rounds (that would undo server-side deletions).
    fbLoadRounds(user.uid).then(fbRounds => {
      rounds = fbRounds;
      // Sync localStorage to match Firebase (clears stale local rounds)
      saveRounds(rounds);
      renderHistory();
    }).catch(() => {
      // Fallback to localStorage if Firebase is unavailable
      rounds = loadRounds();
      renderHistory();
    });

    function renderHistory() {
      const container = document.getElementById('historyList');
      if (!rounds.length) {
        container.innerHTML = `<div class="empty-state"><div class="icon">&#128203;</div><p>No rounds yet.<br><a href="index.html">Start playing</a> to build your history.</p></div>`;
        return;
      }

      // All rounds sorted newest first — latest round always at top
      const sorted = [...rounds].sort((a, b) => new Date(b.date) - new Date(a.date));

      function renderRoundCard(r) {
        const isIncomplete = isRoundIncomplete(r);
        return `
        <div class="history-card">
          <h3>${r.courseName}${r.groupCode ? ' <span style="font-size:11px;color:var(--gold);font-family:monospace;letter-spacing:1px">[' + r.groupCode + ']</span>' : ''}${isIncomplete ? ' <span style="font-size:10px;color:var(--bogey);font-weight:600;background:rgba(255,82,82,0.12);padding:2px 6px;border-radius:4px;vertical-align:middle">ENDED EARLY</span>' : ''}</h3>
          <div class="date">${formatDate(r.date)}  &bull;  ${r.teeLabel} Tees</div>
          <div class="history-scores">
            ${r.players.map(p => {
              const total = r.scores[p].reduce((a, b) => a + b, 0);
              const holesPlayed = r.scores[p].filter(s => s > 0).length;
              const parPlayed = r.holePars ? r.holePars.filter((hp, i) => r.scores[p][i] > 0).reduce((a, b) => a + b, 0) : r.par;
              const diffStr = holesPlayed > 0 ? formatDiff(total, parPlayed) : '—';
              const playerIncomplete = holesPlayed < 18;
              let trackSummary = '';
              if (r.tracking && r.tracking[p]) {
                const t = r.tracking[p];
                const totalPutts = t.putts.reduce((a,b)=>a+b,0);
                const totalMulligans = t.mulligans.reduce((a,b)=>a+b,0);
                const fwHit = t.fairway.filter(Boolean).length;
                const girHit = t.gir.filter(Boolean).length;
                const parts = [];
                if (totalPutts > 0) parts.push(totalPutts + ' putts');
                if (fwHit > 0) parts.push(fwHit + ' FW');
                if (girHit > 0) parts.push(girHit + ' Greens');
                if (totalMulligans > 0) {
                  // Check for location breakdown
                  var locCounts = { tee: 0, fairway: 0, green: 0 };
                  var hasLocs = false;
                  if (t.mulliganLocations) {
                    for (var mi = 0; mi < 18; mi++) {
                      if (t.mulliganLocations[mi] && Array.isArray(t.mulliganLocations[mi])) {
                        t.mulliganLocations[mi].forEach(function(loc) { if (locCounts.hasOwnProperty(loc)) { locCounts[loc]++; hasLocs = true; } });
                      }
                    }
                  }
                  if (hasLocs) {
                    var locParts = [];
                    if (locCounts.tee > 0) locParts.push(locCounts.tee + ' tee');
                    if (locCounts.fairway > 0) locParts.push(locCounts.fairway + ' FW');
                    if (locCounts.green > 0) locParts.push(locCounts.green + ' green');
                    parts.push(totalMulligans + ' mull. (' + locParts.join(', ') + ')');
                  } else {
                    parts.push(totalMulligans + ' mull.');
                  }
                }
                if (parts.length) trackSummary = '<span style="font-size:11px;color:var(--text-muted);display:block;margin-top:2px">' + parts.join(' &bull; ') + '</span>';
              }
              return '<div class="history-score-row"><div><span>' + p + '</span>' + (playerIncomplete ? '<span style="font-size:10px;color:var(--bogey);margin-left:6px">(' + holesPlayed + '/18)</span>' : '') + trackSummary + '</div><span><strong>' + total + '</strong> (' + diffStr + ') &bull; ' + holesPlayed + '/18</span></div>';
            }).join('')}
          </div>
          <div class="history-actions">
            <button class="btn-outline" onclick="showDetail('${r.id}')">Scorecard</button>
            <button class="btn-danger" onclick="deleteRound('${r.id}')">Delete</button>
          </div>
        </div>`;
      }

      let html = '';
      html += '<div class="section-title">Your Rounds</div>';
      html += sorted.map(renderRoundCard).join('');
      container.innerHTML = html;
    }

    window.showDetail = function(roundId) {
      const round = rounds.find(r => r.id === roundId);
      if (!round) return;

      const isIncomplete = isRoundIncomplete(round);
      document.getElementById('detailTitle').textContent = `${round.courseName} — ${formatDate(round.date)}`;

      let html = '';
      if (isIncomplete) {
        html += '<div style="background:rgba(255,82,82,0.1);border:1px solid rgba(255,82,82,0.25);border-radius:8px;padding:8px 12px;margin-bottom:12px;font-size:12px;color:var(--bogey);text-align:center;font-weight:600">Ended Early — stats reflect only holes played</div>';
      }

      html += '<table class="detail-table"><tr><th class="hole-col">Hole</th><th>Par</th>';
      round.players.forEach(p => {
        const hp = round.scores[p].filter(s => s > 0).length;
        html += '<th>' + p + (hp < 18 ? ' <span style="font-size:9px;color:var(--bogey)">(' + hp + 'h)</span>' : '') + '</th>';
      });
      html += '</tr>';

      for (let i = 0; i < 18; i++) {
        if (i === 9) {
          html += '<tr class="nine-total"><td class="hole-col">OUT</td><td>' + round.holePars.slice(0,9).reduce((a,b)=>a+b,0) + '</td>';
          round.players.forEach(p => html += '<td>' + (round.scores[p].slice(0,9).reduce((a,b)=>a+b,0)||'-') + '</td>');
          html += '</tr>';
        }
        html += '<tr><td class="hole-col">' + (i+1) + '</td><td>' + round.holePars[i] + '</td>';
        round.players.forEach(p => {
          const s = round.scores[p][i];
          const diff = s - round.holePars[i];
          let style = '';
          if (s > 0) {
            if (diff <= -2) style = 'color:var(--eagle);font-weight:700';
            else if (diff === -1) style = 'color:var(--birdie);font-weight:700';
            else if (diff === 0) style = 'color:var(--par-color)';
            else if (diff === 1) style = 'color:var(--bogey)';
            else style = 'color:var(--double);font-weight:700';
          } else {
            style = 'color:var(--text-muted);opacity:0.4';
          }
          html += '<td style="' + style + '">' + (s > 0 ? s : '—') + '</td>';
        });
        html += '</tr>';
      }
      html += '<tr class="nine-total"><td class="hole-col">IN</td><td>' + round.holePars.slice(9).reduce((a,b)=>a+b,0) + '</td>';
      round.players.forEach(p => html += '<td>' + (round.scores[p].slice(9).reduce((a,b)=>a+b,0)||'-') + '</td>');
      html += '</tr>';

      // Total row — show actual par played for incomplete rounds
      html += '<tr class="grand-total"><td class="hole-col">TOT</td><td>' + round.par + '</td>';
      round.players.forEach(p => {
        const total = round.scores[p].reduce((a,b)=>a+b,0);
        const holesPlayed = round.scores[p].filter(s => s > 0).length;
        const parPlayed = round.holePars.filter((hp, i) => round.scores[p][i] > 0).reduce((a, b) => a + b, 0);
        const diff = total - parPlayed;
        const diffStr = holesPlayed === 0 ? '—' : (diff === 0 ? 'E' : (diff > 0 ? '+' + diff : diff.toString()));
        html += '<td>' + total + ' <span style="font-size:11px;color:var(--text-muted)">(' + diffStr + ')</span></td>';
      });
      html += '</tr></table>';

      document.getElementById('detailContent').innerHTML = html;
      document.getElementById('detailModal').classList.add('show');
    };

    window.deleteRound = function(id) {
      if (confirm('Delete this round permanently?')) {
        // Delete from Firebase
        fbDeleteRound(user.uid, id).catch(() => {});

        // Also remove from local
        rounds = rounds.filter(r => r.id !== id);
        saveRounds(rounds);
        renderHistory();
      }
    };

    window.closeModal = function() {
      document.getElementById('detailModal').classList.remove('show');
    };
  });
</script>
</body>
</html>
