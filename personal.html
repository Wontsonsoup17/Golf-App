<!DOCTYPE html>
<html lang="en">
<head>
<style>html,body{background:#0a0f0d}</style>
<script>
(function(){var v='135';var k='app_v';var s=localStorage.getItem(k);if(s&&s!==v){localStorage.setItem(k,v);window.location.replace(window.location.pathname+'?_='+Date.now());return;}localStorage.setItem(k,v);})();
</script>
<meta charset="UTF-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0a0f0d">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<title>My Stats - Westchester Golf</title>
<link rel="stylesheet" href="shared.css?v=143">
</head>
<body>

<div class="header">
  <h1>My Stats</h1>
  <div class="subtitle" id="playerName"></div>
</div>

<div id="activeRoundBanner"></div>

<div class="main">
  <div class="stat-grid" id="statGrid"></div>
  <div id="chartSection"></div>
  <div id="courseStatsSection">
    <div class="waiting-players"><span class="spinner"></span> Loading stats...</div>
  </div>
</div>

<nav class="bottom-nav" id="bottomNav"></nav>

<script src="firebase-config.js?v=143"></script>
<script src="shared.js?v=143"></script>
<script src="firebase-sync.js?v=143"></script>
<script>
  requireAuth(function(user) {
    renderBottomNav('personal');
    renderActiveRoundBanner();

    var displayName = user.displayName || 'You';
    document.getElementById('playerName').textContent = displayName + "'s personal stats";

    fbLoadRounds(user.uid).then(function(rounds) {
      renderPersonalStats(rounds, displayName);
    }).catch(function() {
      renderPersonalStats(loadRounds(), displayName);
    });

    function renderPersonalStats(rounds, myName) {
      if (!rounds.length) {
        document.getElementById('statGrid').innerHTML = '';
        document.getElementById('courseStatsSection').innerHTML = '<div class="empty-state"><div class="icon">&#128100;</div><p>No rounds yet.<br><a href="index.html">Play a round</a> to see your personal stats.</p></div>';
        return;
      }

      // Find my stats across all rounds
      var myRounds = 0, myTotalScore = 0, myBest = Infinity, coursesPlayed = new Set();

      rounds.forEach(function(r) {
        // Find my name in this round (could vary by display name)
        var me = r.players.find(function(p) { return p === myName; });
        if (!me) {
          // Fallback: check all players for a case-insensitive match
          me = r.players.find(function(p) { return p.toLowerCase() === myName.toLowerCase(); });
        }
        if (!me) return;

        var scores = r.scores[me];
        if (!scores) return;
        var total = scores.reduce(function(a, b) { return a + b; }, 0);
        var played = scores.filter(function(s) { return s > 0; }).length;

        if (total > 0 && played >= 9) {
          myRounds++;
          myTotalScore += total;
          if (total < myBest) myBest = total;
          if (r.courseId) coursesPlayed.add(r.courseId);
        }
      });

      var myAvg = myRounds > 0 ? (myTotalScore / myRounds).toFixed(1) : '-';

      // Calculate tracking stats: fairway %, GIR %, avg putts, handicap estimate
      var totalFwHit = 0, totalFwChances = 0, totalGirHit = 0, totalGirChances = 0;
      var totalPutts = 0, totalPuttHoles = 0;

      rounds.forEach(function(r) {
        var me = r.players.find(function(p) { return p === myName; }) ||
                 r.players.find(function(p) { return p.toLowerCase() === myName.toLowerCase(); });
        if (!me || !r.scores[me] || !r.tracking || !r.tracking[me]) return;
        var scores = r.scores[me];
        var t = r.tracking[me];
        var played = scores.filter(function(s) { return s > 0; }).length;
        if (played < 9) return;

        for (var i = 0; i < 18; i++) {
          if (scores[i] > 0) {
            // Fairway: only count par 4+ holes
            var holePar = (r.holePars && r.holePars[i]) ? r.holePars[i] : 4;
            if (holePar >= 4) {
              totalFwChances++;
              if (t.fairway && t.fairway[i]) totalFwHit++;
            }
            // GIR
            totalGirChances++;
            if (t.gir && t.gir[i]) totalGirHit++;
            // Putts
            if (t.putts && t.putts[i] > 0) {
              totalPutts += t.putts[i];
              totalPuttHoles++;
            }
          }
        }
      });

      var fwRate = totalFwChances > 0 ? Math.round((totalFwHit / totalFwChances) * 100) + '%' : '-';
      var girRate = totalGirChances > 0 ? Math.round((totalGirHit / totalGirChances) * 100) + '%' : '-';
      var avgPutts = totalPuttHoles > 0 ? (totalPutts / totalPuttHoles).toFixed(1) : '-';

      // Handicap estimate: average of (score - par) * 0.96, simplified
      var handicap = '-';
      if (myRounds > 0) {
        var diffs = [];
        rounds.forEach(function(r) {
          var me = r.players.find(function(p) { return p === myName; }) ||
                   r.players.find(function(p) { return p.toLowerCase() === myName.toLowerCase(); });
          if (!me || !r.scores[me]) return;
          var total = r.scores[me].reduce(function(a, b) { return a + b; }, 0);
          var played = r.scores[me].filter(function(s) { return s > 0; }).length;
          if (total > 0 && played >= 9) {
            var par = r.par || 72;
            diffs.push(total - par);
          }
        });
        if (diffs.length > 0) {
          // Use best 8 of last 20 differentials (simplified handicap formula)
          diffs.sort(function(a, b) { return a - b; });
          var useCount = Math.max(1, Math.min(8, Math.ceil(diffs.length * 0.4)));
          var bestDiffs = diffs.slice(0, useCount);
          var avgDiff = bestDiffs.reduce(function(a, b) { return a + b; }, 0) / bestDiffs.length;
          handicap = Math.max(0, avgDiff * 0.96).toFixed(1);
        }
      }

      document.getElementById('statGrid').innerHTML =
        '<div class="stat-box"><div class="stat-value">' + myRounds + '</div><div class="stat-label">Rounds</div></div>' +
        '<div class="stat-box"><div class="stat-value">' + (myBest < Infinity ? myBest : '-') + '</div><div class="stat-label">Best Score</div></div>' +
        '<div class="stat-box"><div class="stat-value">' + myAvg + '</div><div class="stat-label">Avg Score</div></div>' +
        '<div class="stat-box"><div class="stat-value">' + handicap + '</div><div class="stat-label">Handicap</div></div>' +
        '<div class="stat-box"><div class="stat-value">' + fwRate + '</div><div class="stat-label">Fairway %</div></div>' +
        '<div class="stat-box"><div class="stat-value">' + girRate + '</div><div class="stat-label">Greens %</div></div>' +
        '<div class="stat-box"><div class="stat-value">' + avgPutts + '</div><div class="stat-label">Avg Putts</div></div>' +
        '<div class="stat-box"><div class="stat-value">' + coursesPlayed.size + '</div><div class="stat-label">Courses</div></div>';

      // Score performance chart
      renderScoreChart(rounds, myName);

      // Per-course breakdown — only my scores
      var courseHtml = '<div class="section-title" style="margin-top:8px">By Course</div>';
      var any = false;

      COURSES.forEach(function(c) {
        var courseRounds = rounds.filter(function(r) { return r.courseId === c.id; });
        if (!courseRounds.length) return;

        var myCourseBest = Infinity, myCourseTotal = 0, myCourseRounds = 0;

        courseRounds.forEach(function(r) {
          var me = r.players.find(function(p) { return p === myName; }) ||
                   r.players.find(function(p) { return p.toLowerCase() === myName.toLowerCase(); });
          if (!me || !r.scores[me]) return;

          var total = r.scores[me].reduce(function(a, b) { return a + b; }, 0);
          var played = r.scores[me].filter(function(s) { return s > 0; }).length;

          if (total > 0 && played >= 9) {
            myCourseRounds++;
            myCourseTotal += total;
            if (total < myCourseBest) myCourseBest = total;
          }
        });

        if (myCourseRounds === 0) return;
        any = true;

        var myCourseAvg = (myCourseTotal / myCourseRounds).toFixed(0);

        courseHtml +=
          '<div class="history-card">' +
            '<h3>' + c.name + '</h3>' +
            '<div style="display:flex;gap:16px;font-size:12px;color:var(--text-muted);margin-top:4px">' +
              '<span>' + myCourseRounds + ' round' + (myCourseRounds > 1 ? 's' : '') + '</span>' +
              '<span>Par ' + c.par + '</span>' +
            '</div>' +
            '<div class="history-scores" style="margin-top:8px">' +
              '<div class="history-score-row">' +
                '<span>Best</span>' +
                '<span><strong>' + myCourseBest + '</strong></span>' +
              '</div>' +
              '<div class="history-score-row">' +
                '<span>Average</span>' +
                '<span>' + myCourseAvg + '</span>' +
              '</div>' +
            '</div>' +
          '</div>';
      });

      document.getElementById('courseStatsSection').innerHTML = any ? courseHtml : '<div style="text-align:center;color:var(--text-muted);font-size:13px;margin-top:16px">Play a full round (9+ holes) to see course stats.</div>';
    }

    function renderScoreChart(rounds, myName) {
      var container = document.getElementById('chartSection');

      // Collect data points: { date, score, courseName, par }
      var points = [];
      rounds.forEach(function(r) {
        var me = r.players.find(function(p) { return p === myName; }) ||
                 r.players.find(function(p) { return p.toLowerCase() === myName.toLowerCase(); });
        if (!me || !r.scores[me]) return;
        var total = r.scores[me].reduce(function(a, b) { return a + b; }, 0);
        var played = r.scores[me].filter(function(s) { return s > 0; }).length;
        if (total > 0 && played >= 9) {
          points.push({
            date: new Date(r.date),
            score: total,
            courseName: r.courseName || 'Unknown',
            par: r.par || 72
          });
        }
      });

      // Sort by date
      points.sort(function(a, b) { return a.date - b.date; });

      if (points.length < 2) {
        container.innerHTML = '<div style="text-align:center;color:var(--text-muted);font-size:13px;margin:16px 0">Play 2+ rounds to see your performance graph.</div>';
        return;
      }

      // Build chart HTML
      container.innerHTML =
        '<div class="section-title" style="margin-top:8px">Score Trend</div>' +
        '<div style="background:var(--card-bg);border:1px solid var(--border-light);border-radius:var(--radius-md);padding:16px 8px 8px;margin-bottom:16px">' +
          '<canvas id="scoreChart" style="width:100%;height:220px"></canvas>' +
        '</div>';

      var canvas = document.getElementById('scoreChart');
      var dpr = window.devicePixelRatio || 1;
      var rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      var ctx = canvas.getContext('2d');
      ctx.scale(dpr, dpr);
      var W = rect.width;
      var H = rect.height;

      // Chart margins
      var ml = 40, mr = 16, mt = 16, mb = 40;
      var cw = W - ml - mr;
      var ch = H - mt - mb;

      // Score range — inverted: 0 at top, max at bottom (lower = better in golf)
      var scores = points.map(function(p) { return p.score; });
      var maxS = Math.max.apply(null, scores);
      var pad = Math.max(3, Math.round(maxS * 0.05));
      var yMin = 0;
      var yMax = maxS + pad;

      // Helpers — inverted Y: low scores at top, high scores at bottom
      function xPos(i) { return ml + (i / (points.length - 1)) * cw; }
      function yPos(s) { return mt + ((s - yMin) / (yMax - yMin)) * ch; }

      // Draw grid lines
      ctx.strokeStyle = 'rgba(255,255,255,0.06)';
      ctx.lineWidth = 1;
      var gridSteps = 5;
      for (var g = 0; g <= gridSteps; g++) {
        var gy = mt + (g / gridSteps) * ch;
        ctx.beginPath();
        ctx.moveTo(ml, gy);
        ctx.lineTo(ml + cw, gy);
        ctx.stroke();

        // Y-axis labels — 0 at top, max at bottom
        var label = Math.round(yMin + (g / gridSteps) * (yMax - yMin));
        ctx.fillStyle = 'rgba(255,255,255,0.35)';
        ctx.font = '10px -apple-system, sans-serif';
        ctx.textAlign = 'right';
        ctx.textBaseline = 'middle';
        ctx.fillText(label, ml - 6, gy);
      }

      // Draw score line
      ctx.strokeStyle = '#00e676';
      ctx.lineWidth = 2;
      ctx.lineJoin = 'round';
      ctx.lineCap = 'round';
      ctx.beginPath();
      for (var i = 0; i < points.length; i++) {
        var px = xPos(i);
        var py = yPos(points[i].score);
        if (i === 0) ctx.moveTo(px, py);
        else ctx.lineTo(px, py);
      }
      ctx.stroke();

      // Draw area fill under line
      ctx.beginPath();
      ctx.moveTo(xPos(0), yPos(points[0].score));
      for (var i = 1; i < points.length; i++) {
        ctx.lineTo(xPos(i), yPos(points[i].score));
      }
      ctx.lineTo(xPos(points.length - 1), mt + ch);
      ctx.lineTo(xPos(0), mt + ch);
      ctx.closePath();
      ctx.fillStyle = 'rgba(0,230,118,0.08)';
      ctx.fill();

      // Draw dots
      for (var i = 0; i < points.length; i++) {
        var px = xPos(i);
        var py = yPos(points[i].score);
        ctx.beginPath();
        ctx.arc(px, py, 4, 0, Math.PI * 2);
        ctx.fillStyle = '#00e676';
        ctx.fill();
        ctx.strokeStyle = '#1a1f2e';
        ctx.lineWidth = 2;
        ctx.stroke();

        // Score label above dot
        ctx.fillStyle = 'rgba(255,255,255,0.7)';
        ctx.font = 'bold 10px -apple-system, sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'bottom';
        ctx.fillText(points[i].score, px, py - 8);
      }

      // Linear regression trend line
      var n = points.length;
      var sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
      for (var i = 0; i < n; i++) {
        sumX += i;
        sumY += points[i].score;
        sumXY += i * points[i].score;
        sumXX += i * i;
      }
      var slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
      var intercept = (sumY - slope * sumX) / n;

      var trendStart = intercept;
      var trendEnd = slope * (n - 1) + intercept;

      ctx.strokeStyle = '#f5a623';
      ctx.lineWidth = 2;
      ctx.setLineDash([6, 4]);
      ctx.beginPath();
      ctx.moveTo(xPos(0), yPos(trendStart));
      ctx.lineTo(xPos(n - 1), yPos(trendEnd));
      ctx.stroke();
      ctx.setLineDash([]);

      // X-axis date labels
      ctx.fillStyle = 'rgba(255,255,255,0.35)';
      ctx.font = '9px -apple-system, sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';

      // Show first, last, and middle date labels (avoid overlapping)
      var labelIndices = [0, points.length - 1];
      if (points.length > 4) labelIndices.splice(1, 0, Math.floor(points.length / 2));

      labelIndices.forEach(function(idx) {
        var d = points[idx].date;
        var dateStr = (d.getMonth() + 1) + '/' + d.getDate();
        ctx.fillText(dateStr, xPos(idx), mt + ch + 8);
      });

      // Legend
      ctx.fillStyle = 'rgba(255,255,255,0.35)';
      ctx.font = '9px -apple-system, sans-serif';
      ctx.textAlign = 'left';

      // Green line = Score
      ctx.strokeStyle = '#00e676';
      ctx.lineWidth = 2;
      ctx.setLineDash([]);
      ctx.beginPath();
      ctx.moveTo(ml + 4, mt + ch + 26);
      ctx.lineTo(ml + 20, mt + ch + 26);
      ctx.stroke();
      ctx.fillText('Score', ml + 24, mt + ch + 23);

      // Gold dashed = Trend
      ctx.strokeStyle = '#f5a623';
      ctx.setLineDash([4, 3]);
      ctx.beginPath();
      ctx.moveTo(ml + 66, mt + ch + 26);
      ctx.lineTo(ml + 82, mt + ch + 26);
      ctx.stroke();
      ctx.setLineDash([]);
      ctx.fillText('Trend', ml + 86, mt + ch + 23);

      // Trend direction label
      var trendDir = slope < -0.3 ? 'Improving' : slope > 0.3 ? 'Declining' : 'Steady';
      var trendColor = slope < -0.3 ? '#00e676' : slope > 0.3 ? '#ff5252' : '#f5a623';
      ctx.fillStyle = trendColor;
      ctx.font = 'bold 10px -apple-system, sans-serif';
      ctx.textAlign = 'right';
      ctx.fillText(trendDir, ml + cw, mt + ch + 23);
    }
  });
</script>
</body>
</html>
